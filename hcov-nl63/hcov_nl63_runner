#!/usr/bin/env bash

SAMPLE=$1

if [[ -n ${HOME}/pipeline/hcov-nl63/${SAMPLE}.tgz ]]; then
    echo Starting ${SAMPLE} run

    # give us a place to work
    mkdir -p ${HOME}/pipeline/hcov-nl63/${SAMPLE}

    # build the pipeline
    python ${HOME}/pipeline-builder/hcov-nl63/build_hcov_nl63_pe_pipeline.py \
        --cores 8 \
        --sample ${SAMPLE} \
        --work-dir ${HOME} \
        --reference-dir ${HOME}/reference/hcov-nl63 \
        --pipeline-dir ${HOME}/pipeline/hcov-nl63/${SAMPLE} \
        --stats-dir ${HOME}/pipeline/hcov-nl63/${SAMPLE} \
        --script ${HOME}/pipeline/hcov-nl63/${SAMPLE}/${SAMPLE}_runner \
        --temp-dir ${HOME}/stats/temp \
        --fastq-dir ${HOME}/pipeline/FASTQ \
        --caller gatk \
        --aligner bwa \
        --preprocessor fastp \
        --sorter samtools

    # run the pipeline
    bash ${HOME}/pipeline/hcov-nl63/${SAMPLE}/${SAMPLE}_runner >${HOME}/pipeline/hcov-nl63/${SAMPLE}/${SAMPLE}.log 2>&1

    # pack up the stuff and clean house
    # rm -f ${HOME}/pipeline/hcov-nl63/${SAMPLE}/${SAMPLE}_R1.trimmed.fastq.gz
    # rm -f ${HOME}/pipeline/hcov-nl63/${SAMPLE}/${SAMPLE}_R2.trimmed.fastq.gz

    cd ${HOME}/pipeline/hcov-nl63/
    tar cfz ${HOME}/pipeline/hcov-nl63/${SAMPLE}.tgz ./${SAMPLE}
    # rm -rf ${HOME}/pipeline/hcov-nl63/${SAMPLE}

    echo Finished ${SAMPLE} run
else
    echo "We have already processed sample ${SAMPLE}"
fi
