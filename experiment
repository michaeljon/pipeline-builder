#!/usr/bin/env bash

THREAD_COUNT=72

# trim (fastp is limited to 16 threads)
time fastp \
    --in1 /home/ubuntu/stats/FASTQ/DPZw_k_R1.fastq.gz \
    --in2 /home/ubuntu/stats/FASTQ/DPZw_k_R2.fastq.gz \
    --out1=/home/ubuntu/pipeline/parts/DPZw_k_trimmed_R1.fastq.gz \
    --out2=/home/ubuntu/pipeline/parts/DPZw_k_trimmed_R2.fastq.gz \
    --verbose \
    --thread 16 \
    --detect_adapter_for_pe \
    -j /home/ubuntu/pipeline/DPZw_k/DPZw_k-trim-fastp.json \
    -h /home/ubuntu/pipeline/DPZw_k/DPZw_k-trim-fastp.html

# split (fastp is limited to 16 threads, disable all quality operations)
time fastp \
    --in1=/home/ubuntu/pipeline/parts/DPZw_k_trimmed_R1.fastq.gz \
    --in2=/home/ubuntu/pipeline/parts/DPZw_k_trimmed_R2.fastq.gz \
    --out1=/home/ubuntu/pipeline/parts/DPZw_k_R1.fastq.gz \
    --out2=/home/ubuntu/pipeline/parts/DPZw_k_R2.fastq.gz \
    --verbose \
    --thread 16 \
    --split 64 \
    --disable_adapter_trimming \
    --disable_trim_poly_g \
    --disable_quality_filtering \
    --disable_length_filtering \
    -j /home/ubuntu/pipeline/DPZw_k/DPZw_k-split-fastp.json \
    -h /home/ubuntu/pipeline/DPZw_k/DPZw_k-split-fastp.html

# align the fragments
for i in {1..64}; do
    SEGMENT=$(printf "%.4d" $i)

    time bwa-mem2 mem \
        -t ${THREAD_COUNT} \
        -Y \
        -M \
        -K 720000000 \
        -v 2 \
        -R "@RG\tID:DPZw_k\tPL:ILLUMINA\tPU:unspecified\tLB:DPZw_k\tSM:DPZw_k" \
        /home/ubuntu/reference/Homo_sapiens_assembly38.fasta \
        /home/ubuntu/pipeline/parts/${SEGMENT}.DPZw_k_R1.fastq.gz \
        /home/ubuntu/pipeline/parts/${SEGMENT}.DPZw_k_R2.fastq.gz |
        pigz >/home/ubuntu/pipeline/DPZw_k/DPZw_k.${SEGMENT}.aligned.sam.gz

    rm /home/ubuntu/pipeline/parts/${SEGMENT}.DPZw_k_R1.fastq.gz
    rm /home/ubuntu/pipeline/parts/${SEGMENT}.DPZw_k_R2.fastq.gz
done

# sort and mark duplicates
for i in {1..64}; do
    SEGMENT=$(printf "%.4d" $i)

    time unpigz --stdout /home/ubuntu/pipeline/DPZw_k/DPZw_k.${SEGMENT}.aligned.sam.gz |
    bamsormadup \
        SO=coordinate \
        threads=${THREAD_COUNT} \
        level=6 \
        tmpfile=/home/ubuntu/stats/temp/DPZw_k \
        inputformat=sam \
        indexfilename=/home/ubuntu/pipeline/DPZw_k/DPZw_k.${SEGMENT}.sorted.bam.bai \
        M=/home/ubuntu/pipeline/DPZw_k/DPZw_k.${SEGMENT}.duplication_metrics >/home/ubuntu/pipeline/DPZw_k/DPZw_k.${SEGMENT}.sorted.bam
done

# merge the segments in a single bam per-segment
ls -1 *.bam > bams.lst
time \
    samtools merge -cfp --threads 64 -b bams.lst -f -o - |
    samtools view --threads 64 --bam --write-index --reference /home/ubuntu/reference/covid_reference.fasta --output DPZw_k.sorted.aligned.bam