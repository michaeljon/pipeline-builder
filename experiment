#!/usr/bin/env bash

# trim (fastp is limited to 16 threads)
time fastp \
    --in1 /home/ubuntu/stats/FASTQ/mgVQ_6_R1.fastq.gz \
    --in2 /home/ubuntu/stats/FASTQ/mgVQ_6_R2.fastq.gz \
    --out1=/home/ubuntu/pipeline/mgVQ_6/mgVQ_6_trimmed_R1.fastq.gz \
    --out2=/home/ubuntu/pipeline/mgVQ_6/mgVQ_6_trimmed_R2.fastq.gz \
    --verbose \
    --thread 16 \
    --detect_adapter_for_pe \
    -j /home/ubuntu/pipeline/mgVQ_6/mgVQ_6-trim-fastp.json \
    -h /home/ubuntu/pipeline/mgVQ_6/mgVQ_6-trim-fastp.html

# split (fastp is limited to 16 threads, disable all quality operations)
time fastp \
    --in1=/home/ubuntu/pipeline/mgVQ_6/mgVQ_6_trimmed_R1.fastq.gz \
    --in2=/home/ubuntu/pipeline/mgVQ_6/mgVQ_6_trimmed_R2.fastq.gz \
    --out1=/home/ubuntu/pipeline/mgVQ_6/mgVQ_6_R1.fastq.gz \
    --out2=/home/ubuntu/pipeline/mgVQ_6/mgVQ_6_R2.fastq.gz \
    --verbose \
    --thread 16 \
    --split 64 \
    --disable_adapter_trimming \
    --disable_trim_poly_g \
    --disable_quality_filtering \
    --disable_length_filtering \
    -j /home/ubuntu/pipeline/mgVQ_6/mgVQ_6-split-fastp.json \
    -h /home/ubuntu/pipeline/mgVQ_6/mgVQ_6-split-fastp.html

# align the fragments
for i in {1..64}; do
    SEGMENT=$(printf "%.4d" $i)

    time bwa-mem2 mem \
        -t 72 \
        -Y \
        -M \
        -K 720000000 \
        -v 2 \
        -R "@RG\tID:mgVQ_6\tPL:ILLUMINA\tPU:unspecified\tLB:mgVQ_6\tSM:mgVQ_6" \
        /home/ubuntu/reference/Homo_sapiens_assembly38.fasta \
        /home/ubuntu/pipeline/mgVQ_6/${SEGMENT}.mgVQ_6_R1.fastq.gz \
        /home/ubuntu/pipeline/mgVQ_6/${SEGMENT}.mgVQ_6_R2.fastq.gz |
        pigz >/home/ubuntu/pipeline/mgVQ_6/mgVQ_6.${SEGMENT}.aligned.sam.gz

    rm /home/ubuntu/pipeline/mgVQ_6/${SEGMENT}.mgVQ_6_R1.fastq.gz
    rm /home/ubuntu/pipeline/mgVQ_6/${SEGMENT}.mgVQ_6_R2.fastq.gz
done

# sort and mark duplicates
for i in {1..64}; do
    SEGMENT=$(printf "%.4d" $i)

    time unpigz --stdout /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.${SEGMENT}.aligned.sam.gz |
    bamsormadup \
        SO=coordinate \
        threads=72 \
        level=6 \
        tmpfile=/home/ubuntu/stats/temp/mgVQ_6 \
        inputformat=sam \
        indexfilename=/home/ubuntu/pipeline/mgVQ_6/mgVQ_6.${SEGMENT}.sorted.bam.bai \
        M=/home/ubuntu/pipeline/mgVQ_6/mgVQ_6.${SEGMENT}.duplication_metrics >/home/ubuntu/pipeline/mgVQ_6/mgVQ_6.${SEGMENT}.sorted.bam
done

# merge the segments in a single bam per-segment
ls -1 *.bam > bams.lst
time \
    samtools merge -cfp --threads 72 -b bams.lst -f -o - |
    samtools view --threads 72 --bam --write-index --reference /home/ubuntu/reference/covid_reference.fasta --output mgVQ_6.sorted.aligned.bam

# create intervals
time samtools view --threads 72 -bh /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.sorted.aligned.bam chr1:1-50000000 >/home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.bam
time samtools index -@ 72 /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.bam

# generate BQSR table
time gatk BaseRecalibrator --java-options '-Xmx8g' \
        -R /home/ubuntu/reference/Homo_sapiens_assembly38.fasta \
        -I /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.bam \
        -O /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000_bqsr.bam.table \
        --verbosity ERROR \
        --preserve-qscores-less-than 6 \
        --known-sites /home/ubuntu/reference/Homo_sapiens_assembly38.dbsnp138.vcf \
        --known-sites /home/ubuntu/reference/Homo_sapiens_assembly38.known_indels.vcf \
        --known-sites /home/ubuntu/reference/Mills_and_1000G_gold_standard.indels.hg38.vcf \
        -L chr1:1-50000000

# apply BSQR
time gatk ApplyBQSR --java-options '-Xmx8g' \
    -R /home/ubuntu/reference/Homo_sapiens_assembly38.fasta \
    -I /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.bam \
    -O /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000_bqsr.bam \
    --verbosity ERROR \
    --emit-original-quals true \
    --preserve-qscores-less-than 6 \
    --static-quantized-quals 10 \
    --static-quantized-quals 20 \
    --static-quantized-quals 30 \
    --bqsr-recal-file /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000_bqsr.bam.table \
    -L chr1:1-50000000

# index the resulting file
time samtools index -@ 72 /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000_bqsr.bam

# call variants using gatk
time gatk HaplotypeCaller --java-options '-Xmx16g' \
    --gatk-config-file /home/ubuntu/bin/gatk-4.2.3.0/GATKConfig.properties \
    -R /home/ubuntu/reference/Homo_sapiens_assembly38.fasta \
    -I /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000_bqsr.bam \
    -O /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf \
    --verbosity ERROR \
    --dbsnp /home/ubuntu/reference/Homo_sapiens_assembly38.dbsnp138.vcf \
    --sequence-dictionary /home/ubuntu/reference/Homo_sapiens_assembly38.dict \
    --pairHMM FASTEST_AVAILABLE \
    --native-pair-hmm-threads 72 \
    --pcr-indel-model NONE \
    --annotation AlleleFraction \
    --annotation Coverage \
    --annotation PossibleDeNovo \
    --intervals chr1:1-50000000

# time gatk SelectVariants --java-options '-Xmx16g' \
#     --gatk-config-file /home/ubuntu/bin/gatk-4.2.3.0/GATKConfig.properties \
#     -R /home/ubuntu/reference/Homo_sapiens_assembly38.fasta \
#     -V /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf \
#     -O /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.filtered.vcf \
#     --verbosity ERROR \
#     -select-type MIXED

# time gatk SelectVariants --java-options '-Xmx16g' \
#     --gatk-config-file /home/ubuntu/bin/gatk-4.2.3.0/GATKConfig.properties \
#     -R /home/ubuntu/reference/Homo_sapiens_assembly38.fasta \
#     -V /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf \
#     -O /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.filtered.vcf \
#     --verbosity ERROR \
#     -xl-select-type INDEL \
#     -xl-select-type SNP \
#     -xl-select-type MNP \
#     -xl-select-type SYMBOLIC \
#     -xl-select-type MIXED 

# call variants using bcftools
time bcftools mpileup \
        --annotate FORMAT/AD,FORMAT/DP,FORMAT/QS,FORMAT/SCR,FORMAT/SP,INFO/AD,INFO/SCR \
        --max-depth 500 \
        --no-BAQ \
        --ignore-overlaps \
        --seed 2601610512 \
        --output-type u \
        --regions chr1:1-50000000 \
        --fasta-ref /home/ubuntu/reference/Homo_sapiens_assembly38.fasta \
        /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000_bqsr.bam 2>/dev/null | \
    bcftools call \
        --threads 72 \
        --annotate FORMAT/GQ,FORMAT/GP,INFO/PV4 \
        --variants-only \
        --multiallelic-caller \
        --ploidy GRCh38 \
        --output-type v  \
        --output /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf 2>/dev/null

# annotation our interval
time vep --dir /home/ubuntu/vep_data \
    --cache \
    --format vcf \
    --vcf \
    --merged \
    --fork 64 \
    --offline \
    --use_given_ref \
    --verbose \
    --force_overwrite  \
    --symbol \
    --fasta /home/ubuntu/reference/Homo_sapiens_assembly38.fasta \
    --input_file /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf \
    --output_file /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.annotated.vcf \
    --stats_file /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.annotated.vcf_summary.html

bgzip mgVQ_6.chr1_1_50000000.vcf
tabix -p vcf mgVQ_6.chr1_1_50000000.vcf.gz

time gatk CollectVariantCallingMetrics \
    --VERBOSITY ERROR \
    --DBSNP /home/ubuntu/reference/chm13v2.0_dbSNPv155.vcf.gz \
    -I /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf.gz \
    -O /home/ubuntu/pipeline/mgVQ_6/mgVQ_6

time vcftools --gzvcf /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf.gz --freq2 --out /home/ubuntu/pipeline/mgVQ_6/mgVQ_6 --max-alleles 2 2>/dev/null &
time vcftools --gzvcf /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf.gz --depth --out /home/ubuntu/pipeline/mgVQ_6/mgVQ_6 2>/dev/null &
time vcftools --gzvcf /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf.gz --site-mean-depth --out /home/ubuntu/pipeline/mgVQ_6/mgVQ_6 2>/dev/null &
time vcftools --gzvcf /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf.gz --site-quality --out /home/ubuntu/pipeline/mgVQ_6/mgVQ_6 2>/dev/null &
time vcftools --gzvcf /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf.gz --missing-indv --out /home/ubuntu/pipeline/mgVQ_6/mgVQ_6 2>/dev/null &
time vcftools --gzvcf /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf.gz --missing-site --out /home/ubuntu/pipeline/mgVQ_6/mgVQ_6 2>/dev/null &
time vcftools --gzvcf /home/ubuntu/pipeline/mgVQ_6/mgVQ_6.chr1_1_50000000.vcf.gz --het --out /home/ubuntu/pipeline/mgVQ_6/mgVQ_6 2>/dev/null &
wait
